const PIECE_POS_LIST=[20,21,22,23,24,19,6,7,8,9,18,5,0,1,10,17,4,3,2,11,16,15,14,13,12],ENEMY_DATA={chum:{speed:.72,can_drop:!0},"chum-rush":{speed:2.31,can_drop:!0},snatcher:{speed:1.04,can_drop:!0},goldie:{speed:.55,can_drop:!0},griller:{speed:1.95,can_drop:!1},scrapper:{speed:1.14,can_drop:!0},steeleel:{speed:.94,can_drop:!1},steelhead:{speed:.65,can_drop:!0}};let sea_z;const SEA_Z={"shakeup-high":151,"shakeup-normal":90,"shakeup-low":64,"shakeship-high":123,"shakeship-normal":89,"shakeship-low":65,"shakehouse-high":138,"shakehouse-normal":112,"shakehouse-low":61,"shakelift-high":116,"shakelift-normal":75,"shakelift-low":36,"shakeride-high":217,"shakeride-normal":98,"shakeride-low":68},COLOR_GROUND_NDOE="#ff00ac",COLOR_SEA_NDOE="#00acff",COLOR_BOUNDARY_NODE="#9945cd",COLOR_SPAWNER_NODE="#3ccf00";let canvas,canvas_wrapper,canvas_container,contextmenu,right_column,ctx,stageImage,objs,unit_names,layer_names,spawners,spawner_dic,obj_dic,graph_node_dic,graph_area_dic,graph_nodes,graph_areas,start_node,goal_node,start_area,goal_area,start_pos,goal_pos,canvas_scale=1,check_state={"left-scroll":0,stage:"shakeup",tide:"normal",type:"photo",scale:"0.7","input-graph-area":!1,"input-graph-node":!1,"input-time":!0},piece_count=0;const player_dic={},canvas_dic={},ctx_dic={},layer_dic={},key_state={};function update_check_state(){const e=document.querySelectorAll("input[type=checkbox]");Array.prototype.forEach.call(e,e=>{const t=e.getAttribute("id"),a=!!e.checked;check_state[t]=a})}function get_data(e){const t={},a=e.children;return Array.prototype.forEach.call(a,(e,a)=>{let n=e.getAttribute("Name");n||(n=a,t.length=a+1);let o=e.getAttribute("StringValue");if(o){const e=parseFloat(o);isNaN(e)||(o=e),t[n]=o}else t[n]=get_data(e)}),t}function load_xml(e,t){const a=new XMLHttpRequest;a.onreadystatechange=function(){if(4===a.readyState&&200===a.status){const e=check_state.tide,n=a.responseXML.documentElement.querySelectorAll("Root>C1>C0>C1");objs=[],graph_nodes=[],graph_areas=[],spawners=[],spawner_dic={},obj_dic={},graph_node_dic={},graph_area_dic={},unit_names=[],layer_names=[],Array.prototype.forEach.call(n,(e,t)=>{const a=get_data(e),n=a.UnitConfigName,o=a.LayerConfigName;unit_names.includes(n)||unit_names.push(n),layer_names.includes(o)||layer_names.push(o),objs.push(a),obj_dic[a.Id]=a}),layer_names.sort(),unit_names.sort(),objs.forEach(t=>{if(t.UnitConfigName.includes("CoopGraphNode")){const e=new GraphNode(t);e.is_sea_node=e.z<sea_z,graph_nodes.push(e),t.graph_node=e,graph_node_dic[e.id]=e}else if(t.UnitConfigName.includes("Obj_CoopGraphArea")){const e=new GraphArea(t);graph_areas.push(e),graph_area_dic[e.id]=e}else if(t.UnitConfigName.includes("Obj_CoopSpawnPointZako")){t.LayerConfigName,t.LayerConfigName,t.LayerConfigName;if("CoopWater_0"===t.LayerConfigName&&"low"===e||"CoopWater_1"===t.LayerConfigName&&"normal"===e||"CoopWater_2"===t.LayerConfigName&&"high"===e){const e=new GraphNode(t);e.is_spawner=!0,spawners.push(e),spawner_dic[e.id]=spawners}}}),objs.forEach(e=>{if(e.UnitConfigName.includes("CoopGraphNode")){const t=e.Links;if(t&&Object.keys(t).length)for(let a in t){const n=t[a].length;for(let o=0;o<n;o++){const n=t[a][o];let r=null;const s=n.DefinitionName,i=n.DestUnitId;for(let e=0;e<graph_nodes.length;e++)if(i===graph_nodes[e].id){r=graph_nodes[e];break}r&&("ToGraphNodeUnidirectionalDrop"===s?(e.graph_node.links.push(r),r.back_links.push(e.graph_node)):(e.graph_node.links.push(r),r.links.push(e.graph_node),e.graph_node.back_links.push(r),r.back_links.push(e.graph_node)))}}}}),graph_nodes.forEach(e=>{if(!e.is_sea_node)for(let t=0;t<e.links.length;t++)e.links[t].is_sea_node&&(e.links[t].is_boundary_node=!0)}),graph_nodes.forEach(e=>{const t=[];if(graph_areas.forEach(a=>{a.includesNodeStrict(e)&&t.push(a)}),t.length){t.sort((e,t)=>e.front>t.front?1:-1);const a=t[0];a.nodes.push(e),e.parent_area=a}});const o=[];graph_areas.forEach(e=>{e.nodes.length<1&&o.push(e)}),o.forEach(e=>{const t=graph_areas.indexOf(e);graph_areas.splice(t,1)}),spawners.forEach(e=>{const t=[];if(graph_areas.forEach(a=>{a.includesNode(e)&&t.push(a)}),t.length){t.sort((e,t)=>e.front>t.front?1:-1);const a=t[0];let n;e.parent_area=a;let o=1/0;a.nodes.forEach(t=>{const a=get_distance_2d(e,t);a<o&&(o=a,n=t)}),e.links=[n],n.links.forEach(t=>{e.links.push(t)}),e.links.forEach(t=>{t.spawner_links.push(e)})}}),graph_node_dic.obj6516&&(graph_node_dic.obj6516.penalty=45),graph_node_dic.obj10501&&(graph_node_dic.obj10501.penalty=1),graph_node_dic.obj8580&&(graph_node_dic.obj8580.snatcher_penalty=-200),graph_node_dic.obj9264&&(graph_node_dic.obj9264.snatcher_penalty=-10),update_canvas(),t&&t()}},a.open("GET","./assets/xml/"+e+".xml"),a.send(null)}function get_obj(e){for(let t=0;t<objs.length;t++)if(objs[t].Id===e)return objs[t];return null}function clear_canvas(){layer_dic.graph_node.innerHTML="",layer_dic.graph_area.innerHTML="",ctx_dic.stage.clearAll(),ctx_dic.node_link.clearAll(),ctx_dic.route.clearAll()}function update_canvas(){update_check_state(),clear_canvas(),remvoe_all_piece(),ctx_dic.stage.drawImage(stageImage,0,0),graph_areas.forEach(e=>{const t=document.createElement("div");e.div=t,t.classList.add("graph-area"),t.style.setProperty("left",e.x+"px"),t.style.setProperty("top",e.y+"px"),t.style.setProperty("width",e.width+"px"),t.style.setProperty("height",e.height+"px"),t.setAttribute("title",e.id),layer_dic.graph_area.appendChild(t),t.on("click",t=>{console.log(e)})}),graph_nodes.forEach(e=>{const t=document.createElement("div");e.div=t,t.classList.add("graph-node"),t.style.setProperty("left",e.x+"px"),t.style.setProperty("top",e.y+"px"),t.setAttribute("title",e.id),e.is_sea_node&&t.classList.add("sea-node"),e.is_boundary_node&&t.classList.add("boundary-node"),layer_dic.graph_node.appendChild(t),t.on("click",t=>{console.log(e)})}),spawners.forEach(e=>{const t=document.createElement("div");e.div=t,t.classList.add("graph-node"),t.classList.add("spawner"),t.style.setProperty("left",e.x+"px"),t.style.setProperty("top",e.y+"px"),t.setAttribute("title",e.id),layer_dic.graph_node.appendChild(t),t.on("click",t=>{console.log(e)})}),ctx_dic.node_link.clearAll(),objs.forEach(e=>{if(!e.UnitConfigName.includes("CoopGraphNode"))return;e.LayerConfigName;const t=e.Translate.X+1200,a=e.Translate.Z+1200,n=e.Links,o=ctx_dic.node_link;if(n&&Object.keys(n).length){for(let r in n){const s=n[r].length;for(let i=0;i<s;i++){const s=n[r][i],c=s.DefinitionName,l=get_obj(s.DestUnitId);if(l){const n=l.Translate.X+1200,r=l.Translate.Z+1200;if(e.graph_node.is_boundary_node||l.graph_node.is_boundary_node){const s=e.graph_node.is_boundary_node?COLOR_BOUNDARY_NODE:e.graph_node.is_sea_node?COLOR_SEA_NDOE:COLOR_GROUND_NDOE,i=l.graph_node.is_boundary_node?COLOR_BOUNDARY_NODE:l.graph_node.is_sea_node?COLOR_SEA_NDOE:COLOR_GROUND_NDOE,c=o.createLinearGradient(t,a,n,r);c.addColorStop(0,s),c.addColorStop(1,i),o.strokeStyle=c}else e.graph_node.is_sea_node&&l.graph_node.is_sea_node?o.strokeStyle=COLOR_SEA_NDOE:o.strokeStyle=COLOR_GROUND_NDOE;"ToGraphNodeUnidirectionalDrop"===c?(o.lineWidth=4,o.setLineDash([4,4,14,4])):(o.lineWidth=1,o.setLineDash([])),o.beginPath(),o.moveTo(t,a),o.lineTo(n,r),o.stroke()}}}o.setLineDash([])}}),save_storage(),update_route()}function save_storage(){const e={check_state:check_state};localStorage.setItem("shakerouter",JSON.stringify(e))}function clear_storage(){localStorage.removeItem("shakerouter")}function ask_clear_storage(){window.confirm(get_lang("confirm-clear-localstorage"))&&(localStorage.removeItem("shakerouter"),location.reload())}function select_stage(e,t,a){loading.classList.remove("transparent"),loading.classList.remove("hidden");const n=new Image;n.onload=(()=>{stageImage=n,ctx_dic.stage.clearAll(),ctx_dic.stage.drawImage(stageImage,0,0),load_xml(e,()=>{loading.classList.add("transparent"),setTimeout(()=>{loading.classList.add("hidden"),loading.classList.remove("transparent")},500)}),save_storage()}),n.src=`./assets/${a}/${e}-${t}.png`,sea_z=SEA_Z[`${e}-${t}`]}function change_stage(){check_state.stage=get_elm("input[type=radio][name=stage]:checked").attr("value"),check_state.tide=get_elm("input[type=radio][name=tide]:checked").attr("value"),check_state.type=get_elm("input[type=radio][name=type]:checked").attr("value"),select_stage(check_state.stage,check_state.tide,check_state.type),save_storage()}function change_type(){check_state.type=get_elm("input[type=radio][name=type]:checked").attr("value");const e=new Image;e.onload=(()=>{stageImage=e,ctx_dic.stage.clearAll(),ctx_dic.stage.drawImage(stageImage,0,0)}),e.src=`./assets/${check_state.type}/${check_state.stage}-${check_state.tide}.png`,save_storage()}function change_scale(){const e=document.querySelector("input[type=radio][name=scale]:checked").value;check_state.scale=e;const t=parseFloat(e);let a=parseInt(2400*t);const n=get_elm("#right"),o=n.getBoundingClientRect(),r=window.innerHeight,s=window.innerWidth-o.left,i=Math.min(r,s);.5===t&&(a=i);const c=a/2400;canvas_scale=c,canvas_container.style.setProperty("transform",`scale(${c})`),n.scrollTop=Math.max(0,(a-r)/2),n.scrollLeft=Math.max(0,(a-s)/2),canvas_wrapper.width(2400*c).height(2400*c),save_storage()}function get_elm(e){return document.querySelector(e)}function get_elms(e){return document.querySelectorAll(e)}function create_elm(e,t,...a){const n=document.createElement(e);return t&&n.attr(t),a.length&&a.forEach(e=>{"string"==typeof e?n.textContent=e:n.appendChild(e)}),n}function remvoe_all_piece(){const e=get_elms(".piece-player"),t=get_elms(".piece-enemy"),a=get_elms(".piece-egg");e.forEach(e=>{remove_player(e)}),t.forEach(e=>{remove_enemy(e)}),a.forEach(e=>{remove_egg(e)}),piece_count=0}function remove_player(e){get_elms(".piece-enemy").forEach(t=>{t.route_dic[e.id]=null}),e.is_removed=!0,e.remove()}function add_player(e=-1,t=-1){if(e<0||t<0){const a=PIECE_POS_LIST.indexOf(piece_count%25);e=1200+100*(a%5-2),t=1200+100*(Math.floor(a/5)-2)}const a=create_elm("div",{class:"draggable-piece piece-player",style:`left: ${e}px; top: ${t}px; --image: url(./piece/player-1.png);`,piece:"player"}).makeDraggable({drag_start:()=>{if(contextmenu.hide(),key_state.Alt)return remove_player(a),update_route(),!1},drag:()=>{get_elms(".piece-enemy").forEach(e=>{e.route_dic[a.id]=null}),set_timer_update_route()}}).makeContextmenu({ready:()=>{contextmenu.innerHTML=`\n\t\t\t<ul>\n\t\t\t\t<label for="radio-layer-upper"><li><input type="radio" id="radio-layer-upper" name="radio-layer"><div>${get_lang("upper")}</div></li></label>\n\t\t\t\t<label for="radio-layer-lower"><li><input type="radio" id="radio-layer-lower" name="radio-layer"><div>${get_lang("lower")}</div></li></label>\n\t\t\t\t<hr>\n\t\t\t\t<li id="contextmenu-delete">${get_lang("delete")}</li>\n\t\t\t</ul>`,get_elm("#contextmenu-delete").on("click",e=>{remove_player(a),update_route(),contextmenu.hide()}),a.use_upper_area?get_elm("#radio-layer-upper").checked=!0:get_elm("#radio-layer-lower").checked=!0,get_elms("[name=radio-layer]").on("change",e=>{const t="radio-layer-upper"===get_elm("[name=radio-layer]:checked").id;a.use_upper_area=t;const[n,o]=get_parent_area(a,t);n&&(a.snap_target_node&&(a.x=o.x,a.y=o.y,a.left(o.x),a.top(o.y),a.snap_target_node=o),a.parent_area=n,a.z=o.z),get_elms(".piece-enemy").forEach(e=>{e.route_dic[a.id]=null}),update_route()})}}).appendTo(layer_dic.piece),[n,o]=get_parent_area({x:e,y:t},!0);return n&&(a.parent_area=n,a.z=o.z),a.use_upper_area=!0,a.x=e,a.y=t,a.id="player-"+piece_count,player_dic[a.id]=a,piece_count++,a}let timer_update_route,last_time_update_route;function set_timer_update_route(){timer_update_route||(timer_update_route=setTimeout(()=>{update_route(),timer_update_route=null},100))}function update_route(){const e=get_elms(".piece-player"),t=get_elms(".piece-enemy");t.forEach(t=>{e.forEach(e=>{t.route_dic[e.id]||(t.route_dic[e.id]=create_route(t,e))})}),t.forEach(e=>{if("snatcher"!==e.enemy_key)if(e.target=null,"steelhead"===e.enemy_key){let t=1/0,a=null;player_ids=Object.keys(e.route_dic),player_ids.forEach(n=>{const o=get_distance_3d(player_dic[n],e);o<t&&(t=o,a=n)}),a&&(e.target=player_dic[a])}else{let t=1/0,a=null;player_ids=Object.keys(e.route_dic),player_ids.forEach(n=>{if(e.route_dic[n]){const o=e.route_dic[n].distance_3d;o<t&&(t=o,a=n)}}),a&&(e.target=player_dic[a])}});const a=ctx_dic.route;a.clearAll(),t.forEach(e=>{if(e.querySelector(".fukidashi").hide(),"snatcher"!==e.enemy_key){const t=e.target;if(t){const n=e.route_dic[t.id];if(n){const t=n.distance_2d/e.speed/60;e.querySelector(".fukidashi").show().textContent=t.toFixed(1)+" sec.";const o=n.path;a.lineWidth=6,a.strokeStyle="#ff00ac",a.beginPath(),a.moveTo(o[0].x,o[0].y);for(let e=1;e<o.length;e++)a.lineTo(o[e].x,o[e].y);a.stroke(),a.beginPath(),a.arrowHead(o[o.length-1],o[o.length-2]),a.fillStyle="#ff00ac",a.fill()}}}else if(e.route_go&&e.route_return){const t=3.55,n=e.route_go.distance_2d/e.speed/60,o=3===e.egg.egg_count?12.66:2===e.egg.egg_count?8.4:4.21,r=e.route_return.distance_2d/e.speed/60,s=t+n,i=t+n+o,c=t+n+o+r;let l,_;e.querySelector(".fukidashi").show().text(`${s.toFixed(1)} / ${i.toFixed(1)} / ${c.toFixed(1)} sec.`),_=(l=e.route_go).path,a.lineWidth=6,a.strokeStyle=COLOR_GROUND_NDOE,a.beginPath(),a.moveTo(_[0].x,_[0].y);for(let e=1;e<_.length;e++)a.lineTo(_[e].x,_[e].y);a.stroke(),a.globalCompositeOperation="screen",_=(l=e.route_return).path,a.lineWidth=6,a.strokeStyle=COLOR_SEA_NDOE,a.beginPath(),a.moveTo(_[0].x,_[0].y);for(let e=1;e<_.length-1;e++)a.lineTo(_[e].x,_[e].y);a.stroke();for(let e=_.length-2;e>=0;e--){const t=copy_vector(_[e+0]),n=copy_vector(_[e+1]);if(get_distance_2d(t,goal_pos)>20){const e=get_added_vector(create_vec(t,n),20),o={x:t.x-e.x,y:t.y-e.y};a.beginPath(),a.moveTo(t.x,t.y),a.lineTo(o.x,o.y),a.stroke(),a.globalCompositeOperation="source-over",a.beginPath(),a.arrowHead(n,o),a.fillStyle=COLOR_SEA_NDOE,a.fill();break}}a.globalCompositeOperation="source-over"}})}function remove_enemy(e){e.is_removed=!0,e.remove()}function add_enemy(e="chum",t,a=-1,n=-1){const o=ENEMY_DATA[e];if(a<0||n<0){const e=PIECE_POS_LIST.indexOf(piece_count%25);a=1200+100*(e%5-2),n=1200+100*(Math.floor(e/5)-2)}const r=create_elm("div",{class:"draggable-piece piece-enemy",style:`left: ${a}px; top: ${n}px; --image: url(./piece/enemy-${e}.png);`,piece:e},create_elm("div",{class:"fukidashi"},""));"snatcher"!==e&&r.makeDraggable({drag_start:()=>{if(contextmenu.hide(),key_state.Alt)return remove_enemy(r),update_route(),!1},drag:()=>{r.route_dic={},set_timer_update_route()}}).makeContextmenu({ready:()=>{contextmenu.innerHTML=`\n\t\t\t\t<ul>\n\t\t\t\t\t<label for="radio-layer-upper"><li><input type="radio" id="radio-layer-upper" name="radio-layer"><div>${get_lang("upper")}</div></li></label>\n\t\t\t\t\t<label for="radio-layer-lower"><li><input type="radio" id="radio-layer-lower" name="radio-layer"><div>${get_lang("lower")}</div></li></label>\n\t\t\t\t\t<hr>\n\t\t\t\t\t<li id="contextmenu-delete">${get_lang("delete")}</li>\n\t\t\t\t</ul>`,get_elm("#contextmenu-delete").on("click",e=>{remove_enemy(r),update_route(),contextmenu.hide()}),r.use_upper_area?get_elm("#radio-layer-upper").checked=!0:get_elm("#radio-layer-lower").checked=!0,get_elms("[name=radio-layer]").on("change",e=>{const t="radio-layer-upper"===get_elm("[name=radio-layer]:checked").id;r.use_upper_area=t;const[a,n]=get_parent_area(r,t);a&&(r.snap_target_node&&(r.x=n.x,r.y=n.y,r.left(n.x),r.top(n.y),r.snap_target_node=n),r.parent_area=a,r.z=n.z),r.route_dic={},update_route()})}}),r.appendTo(layer_dic.piece);const[s,i]=get_parent_area({x:a,y:n},!0);return s&&(r.parent_area=s,r.z=i.z),r.enemy_key=e,r.use_upper_area=!1,r.speed=o.speed,r.x=a,r.y=n,r.can_drop=o.can_drop,r.route_dic={},r.target=t||get_elm(".piece-player"),piece_count++,r}function remove_egg(e){e.snatcher.is_removed=!0,e.snatcher.remove(),e.is_removed=!0,e.remove()}function add_egg(e=3,t=-1,a=-1){if(t<0||a<0){const e=PIECE_POS_LIST.indexOf(piece_count%25);t=1200+100*(e%5-2),a=1200+100*(Math.floor(e/5)-2)}const n=create_elm("div",{class:"draggable-piece piece-egg",style:`left: ${t}px; top: ${a}px; --image: url(./piece/egg-${e}.png);`,piece:"egg"}),o=add_enemy("snatcher",n);n.x=t,n.y=a,n.egg_count=e,n.use_upper_area=!0,n.snatcher=o,o.egg=n,n.makeDraggable({drag_start:()=>{if(contextmenu.hide(),key_state.Alt)return remove_egg(n),update_route(),!1},drag:()=>{n.parent_area&&(o.route_go=create_route_snatcher_go(n),o.route_go&&o.left(o.route_go.path[0].x).top(o.route_go.path[0].y),o.route_return=create_route_snatcher_return(n)),set_timer_update_route()}}).makeContextmenu({ready:()=>{contextmenu.innerHTML=`\n\t\t\t<ul>\n\t\t\t\t<label for="radio-layer-upper"><li><input type="radio" id="radio-layer-upper" name="radio-layer"><div>${get_lang("upper")}</div></li></label>\n\t\t\t\t<label for="radio-layer-lower"><li><input type="radio" id="radio-layer-lower" name="radio-layer"><div>${get_lang("lower")}</div></li></label>\n\t\t\t\t<hr>\n\t\t\t\t<label for="radio-egg-count-1"><li><input type="radio" id="radio-egg-count-1" name="radio-egg-count"><div>${get_lang("egg-1-s")}</div></li></label>\n\t\t\t\t<label for="radio-egg-count-2"><li><input type="radio" id="radio-egg-count-2" name="radio-egg-count"><div>${get_lang("egg-2-s")}</div></li></label>\n\t\t\t\t<label for="radio-egg-count-3"><li><input type="radio" id="radio-egg-count-3" name="radio-egg-count"><div>${get_lang("egg-3-s")}</div></li></label>\n\t\t\t\t<hr>\n\t\t\t\t<li id="contextmenu-delete">${get_lang("delete")}</li>\n\t\t\t</ul>`,get_elm("#contextmenu-delete").on("click",e=>{remove_egg(n),update_route(),contextmenu.hide()}),get_elm("#radio-layer-"+(n.use_upper_area?"upper":"lower")).checked=!0,get_elm("#radio-egg-count-"+n.egg_count).checked=!0,get_elms("[name=radio-egg-count]").on("change",e=>{const t=get_elm("[name=radio-egg-count]:checked"),a=parseInt(t.id.replace("radio-egg-count-",""));n.egg_count=a,n.css("--image",`url(./piece/egg-${a}.png)`),update_route()}),get_elms("[name=radio-layer]").forEach(e=>{e.on("change",e=>{const t="radio-layer-upper"===get_elm("[name=radio-layer]:checked").id;n.use_upper_area=t;const[a,o]=get_parent_area(n,t);a&&(n.snap_target_node&&(n.x=o.x,n.y=o.y,n.left(o.x),n.top(o.y),n.snap_target_node=o),n.parent_area=a,n.z=o.z),n.route_dic={},update_route()})})}}).appendTo(layer_dic.piece);const[r,s]=get_parent_area(n,!0);return r&&(n.parent_area=r,n.z=s.z,o.route_go=create_route_snatcher_go(n),o.route_go&&o.left(o.route_go.path[0].x).top(o.route_go.path[0].y),o.route_return=create_route_snatcher_return(n),set_timer_update_route()),piece_count++,n}function show_help(){get_elm("#left").css("filter","blur(4px)"),get_elm("#right").css("filter","blur(4px)"),get_elm("#help").show()}function hide_help(){get_elm("#left").css("filter","initial"),get_elm("#right").css("filter","initial"),get_elm("#help").classList.add("transparent"),setTimeout(()=>{get_elm("#help").hide(),get_elm("#help").classList.remove("transparent")},500)}function download_image_view(){const e=get_elm("#right"),t=e.getBoundingClientRect(),a=e.scrollLeft/canvas_scale,n=e.scrollTop/canvas_scale,o=(a+t.width)/canvas_scale,r=(n+t.height)/canvas_scale;download_image(a,n,Math.min(2400,o-a),Math.min(2400,r-n))}function download_image_clip(){ctx_dic.clip.clearAll(),ctx_dic.clip.fillStyle="rgba(0, 0, 0, 0.6)",ctx_dic.clip.fillRect(0,0,2400,2400),canvas_dic.clip.show(),get_elm("#right-fix-text").show()}function download_image(e=0,t=0,a=2400,n=2400){const o=canvas_dic.download,r=ctx_dic.download;if(r.fillStyle="white",r.fillRect(0,0,2400,2400),r.drawImage(canvas_dic.stage,0,0),r.globalAlpha=.5,check_state["input-graph-area"]){const[e,t]=create_canvas(2400,2400);get_elms(".graph-area").each(e=>{const a=e.left(),n=e.top(),o=e.width(),r=e.height();t.fillStyle="rgba(0, 120, 255, .1)",t.fillRect(a-o/2,n-r/2,o,r),t.strokeStyle="rgba(0, 120, 255, 1)",t.strokeRect(a-o/2,n-r/2,o,r)}),r.drawImage(e,0,0)}if(check_state["input-graph-node"]){r.drawImage(canvas_dic.node_link,0,0);const[e,t]=create_canvas(2400,2400);t.globalAlpha=.5,get_elms(".graph-node").each(e=>{const a=e.left(),n=e.top(),o=e.classList.contains("boundary-node")?COLOR_BOUNDARY_NODE:e.classList.contains("sea-node")?COLOR_SEA_NDOE:e.classList.contains("spawner")?COLOR_SPAWNER_NODE:COLOR_GROUND_NDOE,r=e.classList.contains("boundary-node")?8:e.classList.contains("spawner")?12:5;t.fillStyle=o,t.fillCircle(a,n,r)}),r.globalAlpha=1,r.drawImage(e,0,0)}r.drawImage(canvas_dic.route,0,0),get_elms(".draggable-piece").each(e=>{let t=e.attr("piece");"player"===t?t+="-1":"egg"===t&&(t+="-"+e.egg_count);const a=get_elm("#img-"+t),n=e.left(),o=e.top();if(check_state["input-time"]){const t=e.querySelector(".fukidashi");if(t){const e=t.text();r.textBaseline="bottom",r.textAlign="left",r.font="bold 24px sans-serif";const a=r.measureText(e).width;r.shadowColor="rgba(0, 0, 0, 0)",r.shadowOffsetX=0,r.shadowOffsetY=0,r.shadowBlur=2,r.strokeStyle="black",r.lineWidth=2,r.fillStyle="white",r.strokeText(e,n+7+18,o-2-28-18),r.shadowColor="black",r.fillText(e,n+7+18,o-2-28-18),r.strokeStyle="white",r.lineWidth=2,r.beginPath(),r.moveTo(n+7,o-28),r.lineTo(n+7+18,o-28-18),r.lineTo(n+7+18+a,o-28-18),r.stroke(),r.stroke()}}t.includes("egg")||(r.shadowColor="rgba(0, 0, 0, 0.3)",r.shadowOffsetX=3,r.shadowOffsetY=3,r.shadowBlur=0,r.fillStyle="red",r.fillCircle(n,o,25),r.shadowColor="rgba(0, 0, 0, 0)",r.fillStyle="white",r.fillCircle(n,o,22)),r.shadowColor="rgba(0, 0, 0, 0.3)",r.shadowOffsetX=3,r.shadowOffsetY=3,r.shadowBlur=0,r.drawImage(a,n-25,o-25,50,50),r.shadowColor="rgba(0, 0, 0, 0)"});const[s,i]=create_canvas(a,n);i.drawImage(o,-e,-t);const c=get_date_str(),l=get_lang("short-"+check_state.stage),_=get_lang("short-"+check_state.tide+"tide"),d=`${l}${"ja"===USER_LANG?"":"_"}${_}_${c}`;s.download(d+".png")}function GraphNode(e){return this.id=e.Id,this.x=e.Translate.X+1200,this.y=e.Translate.Z+1200,this.z=e.Translate.Y,this.is_link_spawner=!1,this.is_spawner=!1,this.is_sea_node=!1,this.is_boundary_node=!1,this.links=[],this.back_links=[],this.spawner_links=[],this.parent_area=null,this}function GraphArea(e){return this.id=e.Id,this.x=e.Translate.X+1200,this.y=e.Translate.Z+1200,this.z=e.Translate.Y,this.width=10*e.Scale.X,this.height=10*e.Scale.Z,this.depth=10*e.Scale.Y,this.top=this.y-this.height/2,this.bottom=this.y+this.height/2,this.left=this.x-this.width/2,this.right=this.x+this.width/2,this.back=this.z-this.depth/2,this.front=this.z+this.depth/2,this.penalty=0,this.nodes=[],this.vertices=[{x:this.left,y:this.top},{x:this.right,y:this.top},{x:this.right,y:this.bottom},{x:this.left,y:this.bottom}],this.edges=[[this.vertices[0],this.vertices[1]],[this.vertices[1],this.vertices[2]],[this.vertices[2],this.vertices[3]],[this.vertices[3],this.vertices[0]]],this}function create_canvas(e,t){const a=document.createElement("canvas");a.width=e,a.height=t;const n=a.getContext("2d");return n.canvas=a,[a,n]}function log_event_type(e,t){}function get_parent_area(e,t){const a=[];if(graph_areas.forEach(t=>{t.includesNode(e)&&a.push(t)}),a.length){a.sort((e,t)=>e.z>t.z?1:-1);const n=a[a.length-1],o=a[0],r=t?n:o;let s,i=1/0;return r.nodes.forEach(t=>{const a=get_distance_2d(t,e);a<i&&(i=a,s=t)}),[r,s]}return[null,null]}function ready_contextmenu(){contextmenu.on("mousedown",e=>{e.stopPropagation()}),contextmenu.on("click",e=>{setTimeout(()=>{contextmenu.hide()},300)}),document.body.on("mousedown",()=>{contextmenu.hide()}),document.body.oncontextmenu=(()=>!1)}function ready_draggable(){const e=document.body,t={};e.draggable_data=t,e.on("mousemove",a=>{if(t.elm){log_event_type(a,e),set_canvasxy(a);const n=t.elm;n.snap_target_node=null,n.parent_area=null;const o=a.canvasX-t.start_mouse_x,r=a.canvasY-t.start_mouse_y;let s=t.start_elm_x+o,i=t.start_elm_y+r;set_canvasxy(a);const c={x:s,y:i};if(key_state.Shift){let e,t=1/0;spawners.forEach(a=>{const n=get_distance_2d(c,a);n<t&&(t=n,e=a)}),e&&(s=e.x,i=e.y,c.x=s,c.y=i)}const[l,_]=get_parent_area(c,n.use_upper_area);l&&(key_state.Control&&(s=_.x,i=_.y,n.snap_target_node=_),n.z=_.z,n.parent_area=l),n.x=s,n.y=i,n.left(s),n.top(i),t.options.drag&&t.options.drag()}}),e.on("mouseup",a=>{log_event_type(a,e),t.elm&&(t.elm=null,t.options.drag_end&&t.options.drag_end())})}function get_distance_2d(e,t={x:0,y:0}){return Math.sqrt((e.x-t.x)**2+(e.y-t.y)**2)}function get_distance_3d(e,t={x:0,y:0}){return Math.sqrt((e.x-t.x)**2+(e.y-t.y)**2+(e.z-t.z)**2)}function get_vector_angle(e,t){let a;a=t?{x:e.x-t.x,y:e.y-t.y}:e;const n=Math.asin(a.y/get_distance_2d(a));return a.y>=0?a.x>0?n:Math.PI-n:a.x>0?2*Math.PI-Math.abs(n):Math.PI+Math.abs(n)}function get_rotated_vector(e,t){const a=Math.sin(t),n=Math.cos(t);return{x:-a*e.y+n*e.x,y:a*e.x+n*e.y}}function get_added_vector(e,t){const a=get_vector_angle(e),n=get_rotated_vector(create_vec(t),a);return{x:e.x-n.x,y:e.y-n.y}}function copy_vector(e){return{x:e.x,y:e.y}}function add_vector(e,t){return{x:e.x+t.x,y:e.y+t.y}}function create_vec(e,t){return t?{x:e.x-t.x,y:e.y-t.y}:{x:e,y:0}}function set_canvasxy(e){let t=e.pageX,a=e.pageY;const n=canvas_container.getBoundingClientRect();t=parseInt((t-n.left)/canvas_scale),a=parseInt((a-n.top)/canvas_scale),e.canvasX=t,e.canvasY=a}function create_route_node_to_node(){if(!start_node||!goal_node)return;graph_nodes.forEach(e=>{e.distance=1/0,e.score=1/0,e.from_node=null}),graph_areas.forEach(e=>{e.score=1/0,e.near_node=null}),start_node.distance=0,start_node.score=0;explore_loop(start_node,null,!1,0);let e=goal_node;ctx.lineWidth=10,ctx.strokeStyle="orange",ctx.beginPath(),ctx.moveTo(e.x,e.y);for(let t=0;t<graph_nodes.length;t++){const t=e.from_node;if(!e||!t)break;if(ctx.lineTo(t.x,t.y),t===start_node)break;e=t}ctx.stroke()}function check_cross_line_vs_area(e,t){let a;return t.edges.forEach(t=>{a||(a=check_cross_line_vs_line(e[0],e[1],t[0],t[1]))}),a}function check_cross_line_vs_line(e,t,a,n){const o={},r=(n.y-a.y)*(n.x-e.x)-(n.x-a.x)*(n.y-e.y),s=(t.x-e.x)*(n.y-e.y)-(t.y-e.y)*(n.x-e.x),i=(t.x-e.x)*(n.y-a.y)-(t.y-e.y)*(n.x-a.x),c=r/i,l=s/i;return c>=0&&c<=1&&l>=0&&l<=1&&(o.x=e.x+c*(t.x-e.x),o.y=e.y+c*(t.y-e.y),o)}function create_route_snatcher_go(e){let t;if(graph_nodes.forEach(e=>{e.distance=1/0,e.score=1/0,e.from_node=null}),e.snap_target_node)(t=e.snap_target_node).distance=0,t.score=0;else{let a;t={is_temp:!0,x:e.x,y:e.y,z:e.z,distance:0,score:0,back_links:[],area:e.parent_area};let n=1/0;if(e.parent_area.nodes.forEach(t=>{const o=get_distance_2d(e,t);o<n&&(n=o,a=t)}),a.back_links.forEach(n=>{if(n.parent_area===e.parent_area)t.back_links.push(n);else{const o=check_cross_line_vs_area([a,n],e.parent_area);if(o){const r={is_temp:!0,x:o.x,y:o.y,z:a.z,distance:1/0,score:1/0,from_node:null,back_links:[],area:e.parent_area};t.back_links.push(r),r.back_links.push(t),r.back_links.push(n)}}}),!t.back_links.length)return}explore_loop_snatcher_go.min_score=1/0,explore_loop_snatcher_go.nearest_node=null,explore_loop_snatcher_go(t,null,0);const a=explore_loop_snatcher_go.nearest_node;if(!a)return;const n=[a];let o=a;for(let e=0;e<graph_nodes.length;e++){const e=o.from_node;if(!o||!e)break;if(n.push(e),e===t)break;o=e}let r=0,s=0;for(let e=1;e<n.length;e++){const t=n[e-1],a=n[e-0];r+=get_distance_2d(t,a),s+=get_distance_3d(t,a)}return{path:n,distance_2d:r,distance_3d:s}}function create_route_snatcher_return(e){let t,a;if(graph_nodes.forEach(e=>{e.distance=1/0,e.score=1/0,e.from_node=null}),e.snap_target_node)(t=e.snap_target_node).distance=0,t.score=0;else{let n=1/0;e.parent_area.nodes.forEach(t=>{const o=get_distance_2d(e,t);o<n&&(n=o,a=t)}),(t=a).distance=0,t.score=0}explore_loop_snatcher_return.min_score=1/0,explore_loop_snatcher_return.nearest_node=null,explore_loop_snatcher_return(t,null,0);const n=explore_loop_snatcher_return.nearest_node;if(!n)return;const o=[n];let r=n;for(let e=0;e<graph_nodes.length;e++){const e=r.from_node;if(!r||!e)break;if(o.push(e),e===t)break;r=e}o.reverse(),e.snap_target_node||(a.links.forEach(t=>{if(t===o[1]){const n=check_cross_line_vs_area([a,t],e.parent_area);if(n){const e={x:n.x,y:n.y,z:a.z};o[0]=e}}}),o.unshift(e));let s=0,i=0;for(let e=1;e<o.length;e++){const t=o[e-1],a=o[e-0];s+=get_distance_2d(t,a),i+=get_distance_3d(t,a)}return{path:o,distance_2d:s,distance_3d:i}}function create_route(e,t){const a=e.parent_area,n=t.parent_area;if(!(a&&n&&e&&t))return;if(a===n)return{path:[e,t],distance:get_distance_2d(e,t)};let o;if(graph_nodes.forEach(e=>{e.distance=1/0,e.score=1/0,e.from_node=null}),graph_areas.forEach(e=>{e.score=1/0,e.near_node=null}),e instanceof GraphNode)(o=e).distance=0,o.score=0;else if(e.snap_target_node)(o=e.snap_target_node).distance=0,o.score=0;else{let t;o={is_temp:!0,x:e.x,y:e.y,z:e.z,distance:0,score:0,links:[],area:e.parent_area};let n=1/0;if(a.nodes.forEach(a=>{const o=get_distance_2d(e,a);o<n&&(n=o,t=a)}),t.links.forEach(n=>{if(n.parent_area===a)(e.can_drop||n.links.includes(t))&&o.links.push(n);else{const r=check_cross_line_vs_area([t,n],a);if(r){const a={is_temp:!0,x:r.x,y:r.y,z:t.z,distance:1/0,score:1/0,from_node:null,links:[],area:e.parent_area};o.links.push(a),a.links.push(o),(e.can_drop||n.links.includes(t))&&a.links.push(n)}}}),!o.links.length)return}explore_loop(o,null,e.can_drop,0);const r=n.near_node;if(!r)return;const s=[r];let i=r;for(let e=0;e<graph_nodes.length;e++){const e=i.from_node;if(!i||!e)break;if(s.push(e),e===o)break;i=e}if(s.reverse(),t.snap_target_node)s[s.length-1]!==t.snap_target_node&&s.push(t.snap_target_node);else{const e=[s[s.length-2],s[s.length-1]];if(s[s.length-2].parent_area){const t=check_cross_line_vs_area(e,s[s.length-2].parent_area);if(!t)return;t.z=s[s.length-1].z,s[s.length-1]=t}s.push(t)}let c=0,l=0;for(let e=1;e<s.length;e++){const t=s[e-1],a=s[e-0];c+=get_distance_2d(t,a),l+=get_distance_3d(t,a)}return{path:s,distance_2d:c,distance_3d:l}}function explore_loop(e,t,a,n){e.links.forEach(o=>{if(o===t)return;if(!e.is_temp&&!a&&!o.links.includes(e))return;const r=o.penalty||0,s=get_distance_3d(e,o)+r,i=e.distance+s,c=e.score+s,l=o.parent_area;l&&c<l.score&&(l.score=c,l.near_node=o),c<o.score&&(o.distance=i,o.score=c,o.from_node=e,explore_loop(o,e,a,n+1))})}function explore_loop_snatcher_go(e,t,a){e.spawner_links&&e.spawner_links.forEach(t=>{const a=t.penalty||0,n=get_distance_3d(e,t)+a,o=(e.distance,e.score+n);o<explore_loop_snatcher_go.min_score&&(t.from_node=e,explore_loop_snatcher_go.min_score=o,explore_loop_snatcher_go.nearest_node=t)}),e.back_links.forEach(n=>{if(n===t)return;if(!e.is_temp&&!n.back_links.includes(e))return;const o=n.penalty||0,r=get_distance_3d(e,n)+o,s=e.distance+r,i=e.score+r;i<n.score&&(n.distance=s,n.score=i,n.from_node=e,i<explore_loop_snatcher_go.min_score&&explore_loop_snatcher_go(n,e,a+1))})}function explore_loop_snatcher_return(e,t,a){e.links.forEach(n=>{if(n===t)return;const o=n.is_boundary_node&&n.snatcher_penalty||0,r=get_distance_3d(e,n)+o,s=e.distance+r,i=e.score+r;i<n.score&&(n.distance=s,n.score=i,n.from_node=e,i<explore_loop_snatcher_return.min_score&&(n.is_boundary_node?(explore_loop_snatcher_return.min_score=i,explore_loop_snatcher_return.nearest_node=n):n.is_sea_node||explore_loop_snatcher_return(n,e,a+1)))})}function get_date_str(){const e=new Date;let t=e.getFullYear(),a=e.getMonth()+1,n=e.getDate(),o=e.getHours(),r=e.getMinutes(),s=e.getSeconds();return`${t=""+t}_${a=("00"+a).slice(-2)}_${n=("00"+n).slice(-2)}_${o=("00"+o).slice(-2)}_${r=("00"+r).slice(-2)}_${s=("00"+s).slice(-2)}`}function get_queries(e){const t=String(e||window.location),a=t.slice(t.indexOf("?")+1),n={};return a?(a.split("&").forEach(e=>{const t=e.split("=");n[t[0]]=t[1]}),n):n}function get_lang(e){return LANG[e]?LANG[e][USER_LANG]:"null"}function translate_all(){get_elms("[lang_key]").each(e=>{const t=get_lang(e.attr("lang_key"));e.text(t)})}window.onkeydown=(e=>{key_state[e.key]=!0}),window.onkeyup=(e=>{key_state[e.key]=!1}),window.addEventListener("DOMContentLoaded",()=>{document.title=get_lang("title"),translate_all(),get_elm("#help-close").on("click",hide_help),get_elm("#left").on("scroll",function(e){check_state["left-scroll"]=this.scrollTop,save_storage()}),loading=get_elm("#loading");const e=localStorage.getItem("shakerouter");e&&Object.assign(check_state,JSON.parse(e).check_state),get_elm("#left").scrollTop=check_state["left-scroll"],get_elms("label").each(e=>{const t=e.querySelector("input[type=radio]");if(t){const a=`input-${t.attr("name")}-${t.attr("value")}`;t.attr("id",a),e.attr("for",a)}}),get_elm(`input[type=radio][name=stage][value=${check_state.stage}]`).checked=!0,get_elm(`input[type=radio][name=tide][value=${check_state.tide}]`).checked=!0,get_elm(`input[type=radio][name=type][value=${check_state.type}]`).checked=!0,get_elm(`input[type=radio][name=scale][value="${check_state.scale}"]`).checked=!0,right_column=get_elm("#right"),canvas_wrapper=get_elm("#canvas-wrapper"),canvas_container=get_elm("#canvas-container"),layer_dic.graph_area=get_elm("#layer-graph-area"),layer_dic.graph_node=get_elm("#layer-graph-node"),layer_dic.piece=get_elm("#layer-piece"),contextmenu=get_elm("#contextmenu"),canvas_dic.download=get_elm("#canvas-download"),ctx_dic.download=canvas_dic.download.getContext("2d"),canvas_dic.stage=get_elm("#canvas-stage"),ctx_dic.stage=canvas_dic.stage.getContext("2d"),canvas_dic.node_link=get_elm("#canvas-node-link"),ctx_dic.node_link=canvas_dic.node_link.getContext("2d"),canvas_dic.route=get_elm("#canvas-route"),ctx_dic.route=canvas_dic.route.getContext("2d"),canvas_dic.clip=get_elm("#canvas-clip"),ctx_dic.clip=canvas_dic.clip.getContext("2d");const t={};canvas_dic.clip.css("pointer-events","auto"),canvas_dic.clip.on("mousedown",e=>{set_canvasxy(e),t.start_x=e.canvasX,t.start_y=e.canvasY,t.is_down=!0}),canvas_dic.clip.on("mousemove",e=>{if(t.is_down){set_canvasxy(e);let a=t.start_x,n=t.start_y,o=e.canvasX,r=e.canvasY,s=Math.min(a,o),i=Math.max(a,o),c=Math.min(n,r),l=i-s+1,_=Math.max(n,r)-c+1;ctx_dic.clip.clearAll(),ctx_dic.clip.fillStyle="rgba(0, 0, 0, 0.6)",ctx_dic.clip.fillRect(0,0,2400,2400),ctx_dic.clip.clearRect(s,c,l,_),ctx_dic.clip.strokeStyle="#fff",ctx_dic.clip.strokeRect(s-1,c-1,l+2,_+2),t.left=s,t.top=c,t.width=l,t.height=_}}),canvas_dic.clip.on("mouseup",e=>{if(t.is_down){t.is_down=!1,canvas_dic.clip.classList.add("transparent");const e=get_elm("#right-fix-text");e.classList.add("transparent"),setTimeout(()=>{canvas_dic.clip.hide(),e.hide(),canvas_dic.clip.classList.remove("transparent"),e.classList.remove("transparent")},500),download_image(t.left,t.top,t.width,t.height)}}),ready_contextmenu(),ready_draggable(),canvas_container.makeContextmenu({ready:e=>{const t=get_lang("add-some");contextmenu.innerHTML=`\n\t\t\t<ul>\n\t\t\t\t<li class="cmenu-add-player">${t.replace("{x}",get_lang("player"))}</li>\n\t\t\t\t<hr>\n\t\t\t\t<li class="cmenu-add-enemy" enemy_key="chum">${t.replace("{x}",get_lang("chum"))}</li>\n\t\t\t\t<li class="cmenu-add-enemy" enemy_key="scrapper">${t.replace("{x}",get_lang("scrapper"))}</li>\n\t\t\t\t<li class="cmenu-add-enemy" enemy_key="steeleel">${t.replace("{x}",get_lang("steeleel"))}</li>\n\t\t\t\t<li class="cmenu-add-enemy" enemy_key="steelhead">${t.replace("{x}",get_lang("steelhead"))}</li>\n\t\t\t\t<li class="cmenu-add-enemy" enemy_key="chum-rush">${t.replace("{x}",get_lang("chum-rush"))}</li>\n\t\t\t\t<li class="cmenu-add-enemy" enemy_key="goldie">${t.replace("{x}",get_lang("goldie"))}</li>\n\t\t\t\t<li class="cmenu-add-enemy" enemy_key="griller">${t.replace("{x}",get_lang("griller"))}</li>\n\t\t\t\t<hr>\n\t\t\t\t<li class="cmenu-add-egg" egg_count="1">${t.replace("{x}",get_lang("egg-1"))}</li>\n\t\t\t\t<li class="cmenu-add-egg" egg_count="2">${t.replace("{x}",get_lang("egg-2"))}</li>\n\t\t\t\t<li class="cmenu-add-egg" egg_count="3">${t.replace("{x}",get_lang("egg-3"))}</li>\n\t\t\t\t<hr>\n\t\t\t\t<li onclick="download_image();">${get_lang("save-image")}</li>\n\t\t\t\t<li onclick="download_image_clip();">${get_lang("save-clip-image")}</li>\n\t\t\t\t<li onclick="download_image_view();">${get_lang("save-view-image")}</li>\n\t\t\t</ul>`,get_elms(".cmenu-add-player").on("click",function(){add_player(e.canvasX,e.canvasY),update_route(),contextmenu.hide()}),get_elms(".cmenu-add-enemy").on("click",function(){add_enemy(this.attr("enemy_key"),null,e.canvasX,e.canvasY),update_route(),contextmenu.hide()}),get_elms(".cmenu-add-egg").on("click",function(){add_egg(parseInt(this.attr("egg_count")),e.canvasX,e.canvasY),update_route(),contextmenu.hide()})}}),get_elm("#layer-graph-node").setVisible(check_state["input-graph-node"]),get_elm("#canvas-node-link").setVisible(check_state["input-graph-node"]),get_elm("#layer-graph-area").setVisible(check_state["input-graph-area"]),get_elm("#input-graph-node").checked=!!check_state["input-graph-node"],get_elm("#input-graph-node").onchange=function(){this.checked?(get_elm("#layer-graph-node").show(),get_elm("#canvas-node-link").show()):(get_elm("#layer-graph-node").hide(),get_elm("#canvas-node-link").hide()),update_check_state(),save_storage()},get_elm("#input-graph-area").checked=!!check_state["input-graph-area"],get_elm("#input-graph-area").onchange=function(){this.checked?get_elm("#layer-graph-area").show():get_elm("#layer-graph-area").hide(),update_check_state(),save_storage()},get_elm("#input-time").checked=!!check_state["input-time"],get_elm("#input-time").onchange=function(){this.checked?canvas_container.classList.remove("hide-time"):canvas_container.classList.add("hide-time"),save_storage()},check_state["input-time"]?canvas_container.classList.remove("hide-time"):canvas_container.classList.add("hide-time"),get_elms("[name=stage]").on("change",change_stage),get_elms("[name=tide]").on("change",change_stage),get_elms("[name=type]").on("change",change_type),get_elms("[name=scale]").on("change",change_scale),get_elms(".add-button").each(e=>{const t=e.attr("name"),a=e.attr("lang_key");switch(t){case"player":e.css("--image","url(./piece/player-1.png)"),e.on("click",()=>{add_player(),update_route()});break;case"enemy":e.css("--image",`url(./piece/enemy-${a}.png)`),e.on("click",()=>{add_enemy(a),update_route()});break;case"egg":e.css("--image",`url(./piece/${a}.png)`),e.on("click",()=>{add_egg(parseInt(a.replace("egg-",""))),update_route()})}}),change_scale(),change_stage()}),GraphArea.prototype.includesNode=function(e){return this.left<=e.x&&e.x<=this.right&&this.top<=e.y&&e.y<=this.bottom},GraphArea.prototype.includesNodeStrict=function(e){return this.left<=e.x&&e.x<=this.right&&this.top<=e.y&&e.y<=this.bottom&&this.back<=e.z&&e.z<=this.front},NodeList.prototype.forEach=Array.prototype.forEach,NodeList.prototype.on=function(){Array.prototype.forEach.call(this,e=>{HTMLElement.prototype.on.apply(e,arguments)})},NodeList.prototype.each=function(e){Array.prototype.forEach.call(this,(t,a,n)=>{e(t,a,n)})},HTMLElement.prototype.left=function(e){return void 0===e?parseFloat(this.style.getPropertyValue("left")):(this.style.setProperty("left","number"==typeof e?e+"px":e),this)},HTMLElement.prototype.top=function(e){return void 0===e?parseFloat(this.style.getPropertyValue("top")):(this.style.setProperty("top","number"==typeof e?e+"px":e),this)},HTMLElement.prototype.bottom=function(e){return void 0===e?parseFloat(this.style.getPropertyValue("bottom")):(this.style.setProperty("bottom","number"==typeof e?e+"px":e),this)},HTMLElement.prototype.right=function(e){return void 0===e?parseFloat(this.style.getPropertyValue("right")):(this.style.setProperty("right","number"==typeof e?e+"px":e),this)},HTMLElement.prototype.width=function(e){return void 0===e?parseFloat(this.style.getPropertyValue("width")):(this.style.setProperty("width",e+"px"),this)},HTMLElement.prototype.height=function(e){return void 0===e?parseFloat(this.style.getPropertyValue("height")):(this.style.setProperty("height",e+"px"),this)},HTMLElement.prototype.text=function(e){return void 0===e?this.textContent:(this.textContent=e,this)},HTMLElement.prototype.setVisible=function(e){return this.style.setProperty("display",e?"block":"none"),this},HTMLElement.prototype.show=function(){return this.style.setProperty("display","block"),this},HTMLElement.prototype.hide=function(){return this.style.setProperty("display","none"),this},HTMLElement.prototype.on=function(e,t,a=!0,n=!1){return e.split(" ").forEach(e=>{this.addEventListener(e,t,{passive:a,capture:n})}),this},HTMLElement.prototype.css=function(e,t){if("object"==typeof e)for(let t in e)this.style.setProperty(t,e[t]);else{if(void 0===t)return this.style.getPropertyValue(e);this.style.setProperty(e,t)}return this},HTMLElement.prototype.attr=function(e,t){if("object"==typeof e)for(let t in e)this.setAttribute(t,e[t]);else{if(void 0===t)return this.getAttribute(e);this.setAttribute(e,t)}return this},HTMLElement.prototype.appendTo=function(e){return e.appendChild(this),this},HTMLElement.prototype.makeDraggable=function(e={}){const t=document.body.draggable_data;return this.on("mousedown",a=>{if(0===a.button){if(log_event_type(a,this),set_canvasxy(a),t.elm=this,t.start_mouse_x=a.canvasX,t.start_mouse_y=a.canvasY,t.start_elm_x=this.left(),t.start_elm_y=this.top(),t.options=e,this.snap_target_node=null,t.options.drag_start){!1===t.options.drag_start(a)&&(t.elm=null)}a.stopPropagation()}}),this},HTMLElement.prototype.makeContextmenu=function(e={}){document.body;const t=t=>{set_canvasxy(t),e.ready(t),contextmenu.left(-1e3),contextmenu.top(-1e3),contextmenu.show(),contextmenu.attr("class","");const a=contextmenu.getBoundingClientRect();return t.pageX+a.width>window.innerWidth&&contextmenu.classList.add("left"),t.pageY+a.height>window.innerHeight&&contextmenu.classList.add("top"),contextmenu.left(t.pageX),contextmenu.top(t.pageY),t.stopPropagation(),!1};let a;return this.on("mousedown",e=>{a=setTimeout(()=>{this.is_removed||t(e)},800)}),this.on("mousemove",()=>{clearTimeout(a)}),this.on("mouseup",()=>{clearTimeout(a)}),this.oncontextmenu=t,this},HTMLElement.prototype.toSelectorStr=function(){let e=this.tagName.toLowerCase();const t=this.attr("id"),a=this.attr("class");if(t&&(e+="#"+t),a){(""+a).split(" ").forEach(t=>{e+=`.${t}`})}return e},CanvasRenderingContext2D.prototype.arrowHead=function(e,t){const a=get_vector_angle(e,t);this.beginPath(),this.save(),this.translate(e.x,e.y),this.rotate(a),this.moveTo(0,0),this.lineTo(-30,-10),this.lineTo(-30,10),this.closePath(),this.restore()},CanvasRenderingContext2D.prototype.clearAll=function(){this.clearRect(0,0,2400,2400)},CanvasRenderingContext2D.prototype.fillCircle=function(e,t,a){this.beginPath(),this.arc(e,t,a,0,2*Math.PI,!1),this.fill()},HTMLCanvasElement.prototype.download=function(e="canvas",t="image/png"){const a=this.getBlob(t),n=window.URL.createObjectURL(a),o=document.createElementNS("http://www.w3.org/1999/xhtml","a");o.href=n,o.download=e;const r=document.createEvent("MouseEvents");r.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),o.dispatchEvent(r)},HTMLCanvasElement.prototype.getBlob=function(e="image/png"){const t=this.toDataURL(e).split(","),a=atob(t[1]),n=t[0].split(":")[1].split(";")[0];let o=new Uint8Array(a.length);for(let e=0;e<a.length;e++)o[e]=a.charCodeAt(e);return new Blob([o],{type:n})};const USER_LANG=(get_queries().lang||navigator.language||navigator.userLanguage||"ja").includes("ja")?"ja":"en",LANG={},LANG_DEF="\nversion|0.0.1\ntitle|サーモンラン ルートマップ|Salmon Run Route Map\nstage|ステージ|Stage\nshakeup|シェケナダム|Spawning Grounds\nshakeship|難破船ドン･ブラコ|Marooner's Bay\nshakehouse|海上集落シャケト場|Lost Outpost\nshakelift|トキシラズいぶし工房|Salmonid Smokeyard\nshakeride|朽ちた箱舟 ポラリス|Ruins of Ark Polaris\ntide|潮位|Tide\nlowtide|干潮|Low Tide\nnormaltide|通常潮|Normal Tide\nhightide|満潮|High Tide\ntype|タイプ|Type\nplan|平面図|Floor Plan\nphoto|リアル|Screenshot\nscale|拡大率|Scale\nfit|画面にフィット|Fit to Screen\nlayer|レイヤー|Layer\nlayer-node|ノード|Node\nlayer-mesh|メッシュ|Mesh\nlayer-time|時間|Time\nadd|追加|Add\nplayer|プレイヤー|Player\nchum|シャケ|Chum\nchum-rush|シャケ(MAXラッシュ)|Chum (HLM Rush)\nsnatcher|タマヒロイ|Snatcher\ngoldie|キンシャケ(霧)|Goldie (Fog)\ngriller|グリル(MAX)|Griller (HLM)\nscrapper|テッパン|Scrapper\nsteeleel|ヘビ|Steel Eel\nsteelhead|バクダン|Steelhead\negg-1|金イクラ(1個)|1 Golden Egg\negg-2|金イクラ(2個)|2 Golden Eggs\negg-3|金イクラ(3個)|3 Golden Eggs\negg-1-s|1個|1 Egg\negg-2-s|2個|2 Eggs\negg-3-s|3個|3 Eggs\ndelete|削除|Remove\nupper|上の階層に配置|Place on upper floors\nlower|下の階層に配置|Place on lower floors\nadd-some|{x}を追加|Add {x}|\nother|その他|Others\nclear-localstorage|ローカルストレージをクリア|Clear Local Storage\nconfirm-clear-localstorage|このページで使用しているローカルストレージを削除してから、このページを再読み込みします。よろしいですか？|Delete the local storage used by this page, and then reload this page. Are you sure?\nselect-range|保存する範囲を選択してください。|Select the range to save.\nsave-image|全体の画像を保存|Save Image|\nsave-clip-image|画像を切り取って保存|Save Clipped Image\nsave-view-image|現在見えている範囲を保存|Save Current View Image|\nhelp|ヘルプ|Help\nclose|閉じる|Close\nshort-shakeup|ダム|Grounds\nshort-shakeship|ドンブラコ|Bay\nshort-shakehouse|シャケト場|Outpost\nshort-shakelift|トキシラズ|Yard\nshort-shakeride|ポラリス|Ark\nshort-lowtide|干潮|LT\nshort-normaltide|通常|NT\nshort-hightide|満潮|HT\n";LANG_DEF.split("\n").forEach(e=>{if(!e)return;const t=e.split("|"),a=t[1].trim(),n=t[2]?t[2].trim():a;LANG[t[0].trim()]={ja:a,en:n}});